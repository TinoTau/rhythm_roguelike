# 🎼 Rhythm Roguelike 战斗系统设计（V3）
## —— 基于卡池构筑与干扰体消除的战斗流程

> 本文档基于 `docs2/battle.txt` 重新设计战斗系统，  
> 核心机制：**卡池构筑 + 干扰体消除 + 段落修复**

---

## 一、系统总览

### 1.1 战斗结构

- **一局**：特定区域 + 特定难度，包含 10 个关卡
- **一个关卡**：一场战斗
- **一场战斗**：创作一首限定条件的歌曲
- **战斗段落**：段落数量由音乐结构决定（通常 4~8 段，根据风格流派不同）
  - PVE 允许玩家使用纯净流派模式和混合流派模式通关
  - 只要符合乐理即可完成战斗，段落数量不是强制的结果判断标准
  - 如果完不成符合乐理的结构，就算挑战失败
- **段落回合**：每段 1~3 个回合

### 1.2 核心机制

1. **卡池系统**：玩家拥有部分可见的卡池，敌人拥有污染卡池
2. **干扰体系统**：根据玩家卡池刷新，造成多重干扰
3. **修复机制**：玩家通过选择正确卡牌修复音轨，消灭干扰体
4. **构筑系统**：通过战斗和商店逐步净化卡池，提升流派纯度

---

## 二、卡池系统设计

### 2.1 玩家卡池构成

每局开始时，玩家获得卡牌池：

- **各音轨 5 张随机卡牌**
  - 每条音轨展示 1 张（可见）
  - 其余 4 张背面（信息被加密）

#### 卡牌类型分类

**① 节奏牌和贝斯牌**
- 符合基调的节奏牌和贝斯牌
- 有默认库，可以通过冒险和探索进行收集
- 用于节奏轨和贝斯轨的自由创作

**② 风格牌和流派牌**
- 符合当前音乐类型的风格牌和流派牌
- **对新玩家全开放，不需要收集**
- 用于主音轨和装饰轨的风格表达

**③ 音符组合牌 + 音阶牌 + 调性牌**
- 有默认库，可以通过冒险和探索进行收集
- 用于主音轨和装饰轨的旋律构建

### 2.2 敌人污染卡池

- **初始状态**：对每条音轨有 4~8 张污染卡（与每场战斗的段落数一致）
- **污染机制**：敌人的技能是用它的卡池污染玩家手牌
- **消除机制**：玩家修复成功时，删除敌人污染池里的卡牌（每条音轨各一张）

---

## 三、战斗流程设计

### 3.1 战斗开始

**进入战斗后玩家能听到**：
- 基调节奏 + 贝斯（系统提供）

**玩家能操作的音轨**：
- **4 轨模式**（标准难度）：节奏轨、贝斯轨、主音轨、装饰轨
- **6 轨模式**（高手难度）：节奏轨、贝斯轨、主旋律轨、对位/和声轨、节奏化装饰轨、纹理/表情轨
- 4 轨和 6 轨是用户可选择的难度，6 轨是将主音和装饰进行拆分（根据实际音乐创作中的分工职责）

**各音轨的卡牌选择**：

**4 轨模式**：
| 音轨类型 | 可选卡牌类型 |
|---------|------------|
| 节奏轨 | 符合基调的节奏牌（自由创作） |
| 贝斯轨 | 符合基调的贝斯牌（自由创作） |
| 主音轨 | 音符组合 + 音阶/调性 + 风格/流派牌 |
| 装饰轨 | 音符组合 + 音阶/调性 + 风格/流派牌 |

**6 轨模式**：
| 音轨类型 | 可选卡牌类型 | 音乐职责 |
|---------|------------|---------|
| 节奏轨 | 符合基调的节奏牌（自由创作） | 拍号、Groove、时间基准 |
| 贝斯轨 | 符合基调的贝斯牌（自由创作） | 和声地基、低频能量 |
| 主旋律轨 | 音符组合 + 音阶/调性 + 风格/流派牌 | 主题动机、情绪方向（流派判定权重最高） |
| 对位/和声轨 | 音符组合 + 音阶/调性 + 风格/流派牌 | 丰富层次、回应主旋律（提升复杂度与纯度） |
| 节奏化装饰轨 | 音符组合 + 音阶/调性 + 风格/流派牌 | 切分、推动力、紧张感（敌人密度干预核心对象） |
| 纹理/表情轨 | 音符组合 + 音阶/调性 + 风格/流派牌 | 空间感、情绪余韵、人声感（高光与终结演出关键层） |

**注意**：6 轨模式不需要增加新的卡牌类型，所有表达轨都使用相同的卡牌类型（音符组合 + 音阶/调性 + 风格/流派牌），区别在于音乐职责，而非卡牌类型。

### 3.2 回合流程

#### ① 干扰体刷新

- **刷新规则**：根据玩家实时卡池刷新
- **刷新逻辑**：卡池里的牌有哪些风格和流派，就会刷出对应风格和流派的干扰
- **干扰体类型**：
  - 可以干扰 1 条或多条音轨
  - 造成 1 种或多种干扰
  - 数量随难度变化

#### ② 干扰效果

干扰体使玩家的每条音轨随机发生变化，偏离本段应该有的：
- 节奏
- 音阶
- 调性
- 风格
- 流派

**注意**：音符组合太明显了，无法干扰

#### ③ 玩家选择

玩家在每条音轨上看到：
- 1~2 张自己卡池里的牌（可见）
- 污染卡牌（来自敌人污染卡池）
- **总共 5~6 张卡牌**

**玩家需要做**：
- 选择正确的卡牌（污染牌也可以是正确的效果）
- 修复音轨，使当前段落符合乐理

#### ④ 回合结算

**修复成功**（玩家判断正确）：
- 消灭对应的干扰体
- 删除敌人污染池里的卡牌（每条音轨各一张）
- 进入下一个段落

**修复失败**：
- 进入下一回合
- 干扰体全部刷新
- 对玩家再次造成来自不同风格和流派的干扰

**强制结束段落**（3 回合后）：
- 如果三个回合以后玩家还没有消灭干扰体
- 强制结束这个段落
- 保留玩家当前的错误选择
- 进入下一个段落

### 3.3 段落推进

**进入下一段落时**：
- 干扰体会根据玩家卡池进行刷新

**段落结束条件**：
- 玩家应对正确则快速结束段落
- 删除敌人的卡牌（每条音轨各一张）
- 直到污染卡池归零

**高手 vs 新手**：

| 玩家类型 | 段落完成方式 | 战斗节奏 |
|---------|------------|---------|
| 高手 | 每个回合做出正确判断，更快结束段落 | 更快完成战斗 |
| 新手 | 每一段都花多个回合来推进，由于错误选择需要增加段落来修复整首曲子 | 较慢完成战斗 |

**挑战失败条件**：
- 如果玩家在完成 8 段之后还没有成功修复
- 挑战失败，结束整局

**段落数量与奖励关系**（参考旧版设计）：

| 段数 | 奖励评价 | 体验含义 |
|------|---------|---------|
| 4 段 | 完美表达 | 高效、好听、专业 |
| 5-6 段 | 稳定完成 | 标准完整曲式 |
| 7-8 段 | 勉强完成 | 结构松散，音乐质量下降 |

**段落延长的代价**（参考旧版设计）：
- 当段数 > 6 时：
  - 音乐密度逐步下降
  - 重复感增强
  - 终结演出简化
  - 结算界面提示："结构松散完成"

---

## 四、流派系统设计

### 4.1 纯流派 vs 混合流派

#### 纯流派玩法

**过关条件**：
- 风格流派纯度高
- 敌人能够造成迷惑的空间越来越小
- 干扰体的干扰能力随着玩家卡池净化而减少
- 玩家能更快做出正确选择结束段落
- 污染卡池越来越小
- 达成通过构筑流派快速结束战斗的效果

#### 混合流派玩法

**过关条件**：
- 与纯流派相反（待设计）
- 可能需要更多段落来呈现混合流派的优点

### 4.2 构筑系统

**构筑过程**：
- 随着玩家对自己卡池的构筑，风格流派越来越成熟
- 风格流派越统一，敌人能够造成迷惑的空间越来越小
- 干扰体的干扰能力是随着玩家卡池净化而减少的

**高手玩法**：
- 高手也可以在风格流派构筑的过程中凭着对音乐的理解直接排除干扰和污染
- 在混合流派玩法中利用污染卡牌获得想要的效果
- 快速闯关
- 这也是游戏本身想要做到的，对乐感的培养

---

## 五、Boss 战设计

### 5.1 Boss 特殊机制

**污染增强**：
- 直接污染玩家的卡池（每条音轨增加 1/3 的污染牌）
- 考验玩家是否真的理解自己正在构筑的流派

**战斗状态**：
- 玩家一般都已经有了成熟的流派和足够的道具
- 需要在污染增强的情况下识别哪些是自己的牌，哪些是污染牌
- 即使没抽到想要的牌，打不出想要的效果，也要通过增加段落来完成战斗

---

## 六、战斗后奖励

### 6.1 敌人掉落

- **破损芯片**（局内货币）
- **几张卡牌**：由玩家 3 选 1 或 5 选 2（根据玩家操作的音轨数量）
- 用于卡池构筑

### 6.2 暗网商人

玩家可以使用破损芯片购买：

**① 黑客工具（一次性道具）**：
- 补救措施的道具
- 看自己牌的道具
- 标记污染牌的道具
- 压制干扰体效果的道具

**② 卡池管理**：
- 删除自己的牌（指定音轨和风格，从卡池里移除，不告知具体是哪张）

---

## 七、视觉反馈与引导

### 7.1 视觉辅助（非音游玩家）

- 让非音游玩家能够看到自己的曲子哪里不对
- 在段落目标未达成的时候添加动画和引导
- 让玩家意识刚才发生了什么，接下来要做什么

### 7.2 战斗长度反馈

**提前结束奖励**：
- 能提前结束战斗的会有额外掉落

**超时警告**：
- 超出 4 段时：战斗画面会出现红边警报
- 超出 6 段时：视野缩小，感受到全方位压迫

**UI 反馈**（参考旧版设计）：
- 本关结束段数
- 推荐完成段数（4 段）
- 与高手参考的差距
- 段落进度可视化（起承转合过程）

### 7.3 干扰体动画

- 通过动画展示干扰体从玩家身上读取噪音
- 然后将噪音放大的过程
- 同时配以文字提示，告诉玩家这是因为卡池里有这些干扰
- 变相提醒玩家自己卡池里有什么

### 7.4 段落进度可视化

- 根据不同的风格流派，4 段不是硬规则
- 但肯定有起承转合的过程
- 让玩家能够看到动画效果，知道自己进行到哪一步了
- 如果需要增加段落来修复，也通过视觉或者人物语音呈现出来

---

## 八、优化方向

### 8.1 奖励增益状态

- 持续几回合看透一张污染卡
- 持续几回合多抽一张卡
- 增益可以叠加
- 甚至可以在玩家使用污染卡完成回合的时候进行奖励
- 让高手越打越快，反馈越来越强烈

**限制**：
- 不能跳段
- 玩家只能通过对结构的理解快速完成一首曲子
- 而不是用跳过的方式

### 8.2 连续错误引导

- 连续错误使用视觉引导
- 帮助玩家理解问题所在

### 8.3 段落灵活性

- 根据不同的风格流派，4 段不是硬规则
- 但肯定有起承转合的过程
- 让玩家能够看到动画效果，知道自己进行到哪一步了

---

## 九、战斗节奏设计

### 9.1 节奏特点

**总体节奏**：
- 偏慢，没有办法像杀戮尖塔一样做到无限抽卡无限循环
- 完全压制敌人的爽感有限

**优势**：
- 不需要设置机制类 boss 来给玩家制造便秘感
- 创作乐曲本身是固定段落数量的
- 一场战斗必须打够 4 个段落是硬性要求

### 9.2 节奏优化

**视觉呈现**：
- 需要在视觉呈现上让玩家能够降低节奏慢的感觉
- 而是造成"还没打够"的体验

---

## 十、社交与收藏系统（PVE 的核心意义）

### 10.1 PVE 的核心意义

> **PVE 的意义不在于战斗本身，而在于：  
> 每次挑战过程中可能产生更多随机的灵感，让玩家有机会超越自己。**

**设计理念**：
- 每次挑战都是一次创作机会
- 挑战过程中可能产生随机灵感
- 这些灵感让玩家有机会创作出超越自己以往水平的作品
- 玩家通过不断挑战，不断超越自己，创作出更完美的音乐

---

### 10.2 音乐收藏与保留

**挑战结束后的保留**：
- 每次挑战时自己创作的音乐
- 应该允许玩家每次保留自己觉得发挥最好的
- 留在自己的曲库里

**保留机制**：
- 玩家可以选择保留挑战中创作的任何一首曲子
- 保留的曲子进入个人曲库
- 通过消费局外代币增加仓库容量

---

### 10.3 音乐修饰与编辑（核心功能）

#### 10.3.1 挑战结束后的修饰

**修饰功能**：
- 挑战结束后，玩家可以消耗**局外代币**对保留的曲子进行再次修饰
- 可以调整结构
- 可以优化结构
- 可以完善细节

**修饰目的**：
- 让保留的曲子更接近玩家心目中的完美状态
- 弥补挑战过程中的遗憾
- 实现挑战中未能实现的灵感

---

#### 10.3.2 解锁收藏后的付费编辑

**编辑功能**（仅限自己的创作）：
- 解锁新的收藏以后，玩家可以对自己曲库里的**自己创作的**曲子进行**付费编辑**
- 使用新解锁的收藏内容（短语模板、词库包、句法规则等）对已有曲子进行编辑
- 让曲子拥有更完美的结构、更丰富的表达

**编辑机制**：
- 消耗局外代币进行付费编辑
- 可以使用新解锁的收藏内容
- 可以调整结构、优化段落、完善细节
- 让玩家拥有更完美的曲子

**编辑限制**：
- **只能编辑自己创作的曲子**：不能编辑其他玩家创作的曲子
- **其他玩家的创作只能收藏**：确保随机性和原创性

**编辑意义**：
- 让玩家有机会不断完善自己的作品
- 通过解锁新收藏，获得新的编辑工具
- 让曲库中的曲子随着玩家成长而不断进化

---

### 10.4 分享与社交

**分享系统**：
- 在广播频道里进行分享
- 其他玩家可以对音乐进行付费收藏
- 这样玩家就有动力使用更高的难度创作更好的音乐

**排行榜**：
- 广播里还应该有流行/分类排行榜
- 供其他玩家随时听歌或者收藏

**分享意义**：
- 玩家分享的是经过修饰和编辑的完美作品
- 这些作品代表了玩家的最高水平
- 其他玩家的收藏和认可，是对玩家创作能力的肯定

---

#### 10.4.1 其他玩家创作的权限限制（重要）

**核心原则**：
> **玩家对于其他玩家的创作，只能付费收藏，无法进行编辑或二次创作，确保随机性和原创性。**

**权限限制**：
- **只能付费收藏**：其他玩家可以对音乐进行付费收藏
- **无法编辑**：不能对其他玩家的创作进行编辑
- **无法二次创作**：不能基于其他玩家的创作进行二次创作
- **只能欣赏**：收藏后只能在自己的曲库中欣赏，不能修改

**设计目的**：
- **确保随机性**：每个玩家的创作都是独特的，不会因为编辑而失去随机性
- **确保原创性**：每个玩家的创作都保持原创性，不会被其他玩家修改
- **保护创作者**：确保创作者的作品不会被他人修改或二次创作

**收藏功能**：
- 收藏后可以在自己的曲库中欣赏
- 可以查看创作信息（创作者、创作时间、流派等）
- 可以分享给其他玩家（但不能编辑）
- 可以付费收藏，支持创作者

---

---

### 10.5 随机灵感系统（PVE 的核心机制）

**灵感产生**：
- 每次挑战过程中可能产生更多随机的灵感
- 这些灵感可能来自：
  - 卡池的随机组合
  - 干扰体的意外干扰
  - 污染卡牌的意外利用
  - 流派混合的意外效果

**灵感作用**：
- 让玩家有机会创作出超越自己以往水平的作品
- 让玩家发现新的音乐可能性
- 让玩家有机会超越自己

**灵感保留**：
- 挑战结束后，玩家可以保留这些灵感
- 通过修饰和编辑，将这些灵感完善成完整的作品
- 让这些灵感成为玩家曲库中的珍贵收藏

---

### 10.6 核心爽点（重新定义）

> **PVE 的真正爽点不是战斗多快，技巧多高，  
> 而是每次挑战过程中可能产生的随机灵感，  
> 让玩家有机会超越自己，  
> 创作出更完美的音乐。**

> **挑战结束后，玩家可以消耗局外代币对保留的曲子进行再次修饰，  
> 解锁新的收藏后，可以对自己曲库里的曲子进行付费编辑，  
> 让自己拥有更完美的曲子，分享出去。  
> 这才是 PVE 的意义。**

> **高手在局外也获得更大的成就感，  
> 不是来自战斗的胜利，  
> 而是来自创作的完美和分享的认可。**

---

## 十一、设计总结

### 11.1 核心机制

1. **卡池构筑**：通过战斗和商店逐步净化卡池，提升流派纯度
2. **干扰体消除**：根据玩家卡池刷新，玩家通过修复音轨消灭干扰体
3. **段落修复**：玩家通过选择正确卡牌修复音轨，推进战斗

### 11.2 玩家体验

- **高手**：通过对音乐的理解快速排除干扰和污染，快速闯关，获得更多创作机会
- **新手**：通过多回合和多段落逐步修复，学习乐理和流派，逐步提升创作能力
- **创作**：每次挑战过程中可能产生随机灵感，让玩家有机会超越自己
- **修饰**：挑战结束后可以消耗局外代币对保留的曲子进行再次修饰，调整结构
- **编辑**：解锁新的收藏后，可以对自己曲库里的曲子进行付费编辑，让曲子更完美
- **分享**：通过音乐收藏和分享获得成就感，这才是真正的爽点

### 11.3 设计目标

> **PVE 的意义不在于战斗本身，  
> 而在于每次挑战过程中可能产生更多随机的灵感，  
> 让玩家有机会超越自己。**

> **挑战结束后，玩家可以消耗局外代币对保留的曲子进行再次修饰，  
> 解锁新的收藏后，可以对自己曲库里的曲子进行付费编辑，  
> 让自己拥有更完美的曲子，分享出去。  
> 这才是 PVE 的意义。**

> **玩家得到的是每次挑战时自己创作的音乐，  
> 应该允许玩家保留、修饰、编辑、分享，  
> 这才是真正的爽点。**

---

## 十二、卡牌生成理念（参考旧版设计）

### 12.1 卡牌的真实含义

**设计理念**（参考旧版即兴生成机制）：
> **卡牌 ≠ 固定音乐内容**  
> **卡牌 = 一组可控的生成规则（Constrained Generator）**

虽然 V3 系统没有即兴生成机制，但卡牌设计可以参考以下理念：
- 玩家选择的是"结构意图"
- 系统生成的是"具体音乐表现"
- 乐理仅存在于系统判断层

### 12.2 卡牌生成的安全边界

**设计原则**：
- 所有生成都受音阶 / 调式约束
- 模板数量有限（非纯随机）
- 变化只发生在表现层，不影响构筑读取

---

（完）

# PVP 状态机与事件流程（State Machine）

本文档用于程序与系统策划，描述 **教学型 PVP（相互污染·结构传递）** 的完整状态机与关键事件。

---

## 一、核心状态总览

### 顶层状态

1. **Match_Init**（对局初始化）
2. **Mode_Selection**（模式选择阶段，根据新手模式选择引导补充）
3. **Perfect_Pool_Phase**（完美卡池阶段）
4. **Structure_Degrade_Phase**（结构崩坏阶段）
5. **Expert_Exit_Phase**（高手离场阶段）
6. **Inheritance_Completion_Phase**（结构继承完成阶段）
7. **Match_End**（结算与复盘）

### 模式分支

**纯净风格模式**：
- 评估指标：纯净度（Purity）
- 核心机制：风格一致性、结构连贯性、污染吸收能力

**混合风格模式**：
- 评估指标：结构连贯性（Coherence）
- 核心机制：结构延续性、变化可控性、污染转译能力

---

## 二、状态 1：Match_Init

**进入条件**：
- PVP 匹配成功

**系统行为**：
- 锁定区域 / 难度 / 基调节奏
- 初始化双方卡池为「完美初始卡组」
- 初始化污染池为空

**转移条件**：
- 双方确认 → 进入 Mode_Selection

---

## 三、状态 2：Mode_Selection（根据新手模式选择引导补充）

**进入条件**：
- 双方确认进入对局

**系统行为**：
- 展示两个选项：
  1. **纯净风格对局**
     - 系统提示："你将学习什么是一个清晰、稳定的表达。"
  2. **混合风格对局**
     - 系统提示："你将学习如何在变化中继续创作。"
- 根据玩家 PVE / 教学局表现，给出轻度推荐（不锁定选择权）

**纯净风格模式初始化**：
- 双方以**各自选定的纯净流派卡组**开局
- 起手卡组内部风格一致
- 系统在第 1 段起即引入结构性干扰（非随机）

**混合风格模式初始化**：
- 双方以**自选混合卡组**开局
- 卡组允许多流派、多结构倾向
- 系统默认允许结构偏移

**转移条件**：
- 双方选择模式 → 进入 Perfect_Pool_Phase

---

## 四、状态 3：Perfect_Pool_Phase

**特征**：
- 双方卡池完整
- 干扰体最少

**允许行为**：
- 正常段落推进
- 无额外教学提示

**纯净风格模式**：
- 前两段必定出现风格边界干扰
- 机械执行既定组合会导致纯净度下降

**混合风格模式**：
- 系统默认允许结构偏移
- 起手即明确："这是一个会改变方向的对局。"

**转移条件**：
- 任意一方完成第 1 个段落 → 进入 Structure_Degrade_Phase

---

## 五、状态 4：Structure_Degrade_Phase

**特征**：
- 每完成一个段落触发结构交换

**关键事件：On_Segment_Complete(player)**
- 对方卡池：每音轨删除 1 张卡
- 删除卡加入完成者污染池
- 向双方同步卡池变化事件

**循环行为**：
- 段落推进
- 干扰体刷新
- 道具（限制性）使用

**纯净风格模式特殊事件**：
- **On_Purity_Check**：每段落结束时评估纯净度
  - 风格一致性检查
  - 结构连贯性检查
  - 污染吸收能力检查
- **On_Purity_Warning**：纯净度下降时触发
  - 系统提示："当前表达保持形式一致，但结构出现漂移。"

**混合风格模式特殊事件**：
- **On_Coherence_Check**：每段落结束时评估结构连贯性
  - 结构延续性检查
  - 变化可控性检查
  - 污染转译能力检查
- **On_Coherence_Warning**：频繁方向反转时触发
  - 系统提示："变化成立，但缺乏承接。"

**转移条件**：
- 任意一方完成整首曲子 → 进入 Expert_Exit_Phase

---

## 六、状态 5：Expert_Exit_Phase

**进入条件**：
- 一方率先完成整首曲子

**系统行为**：
- 标记该玩家为 **Structure_Provider（结构提供者）**
- 该玩家不再参与回合操作
- 其卡池状态被冻结为「初始完美结构」

**对另一方影响**：
- 剩余玩家继续推进
- 后续污染仅来自已冻结结构

**纯净风格模式**：
- 剩余玩家需要维持高纯净度完成创作
- 系统提示："你正在使用高阶纯净结构继续创作。"

**混合风格模式**：
- 剩余玩家需要保持结构连贯性完成创作
- 系统提示："你正在使用高阶混合结构继续创作。"

**转移条件**：
- 剩余玩家完成整首曲子 → 进入 Inheritance_Completion_Phase

---

## 七、状态 6：Inheritance_Completion_Phase

**特征**：
- 新人卡池高度接近高手初始结构
- 污染卡占比极高

**系统行为**：
- 强化结构提示（仅描述，不给答案）
- 标注卡牌来源（来自高手第 X 段）

**纯净风格模式**：
- 系统持续评估纯净度
- 提示："你正在使用高阶纯净结构，完成即是进步。"
- 成功吸收污染卡时提示："你成功将污染卡转化为流派内表达"

**混合风格模式**：
- 系统持续评估结构连贯性
- 提示："你正在使用高阶混合结构，完成即是进步。"
- 成功转译污染卡时提示："你成功将对方结构转化为新支点"

**转移条件**：
- 新人完成曲子 → 进入 Match_End

---

## 八、状态 7：Match_End

**系统行为**：
- 生成结构对照复盘
- 标注结构传递路径
- 结算奖励

**输出数据**：

**纯净风格模式**：
- 回合数对比
- 段落完成时间线
- 污染卡使用记录
- **纯净度评分**：
  - 风格一致性评分
  - 结构连贯性评分
  - 污染吸收能力评分

**混合风格模式**：
- 回合数对比
- 段落完成时间线
- 污染卡使用记录
- **结构连贯性评分**：
  - 结构延续性评分
  - 变化可控性评分
  - 污染转译能力评分

**胜负判定**：
- 双方是否完成曲子
- 比较最终评分（纯净度或结构连贯性）
- 若评分接近：使用回合数更少者胜

（完）

